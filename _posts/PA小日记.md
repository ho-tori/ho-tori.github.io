## PA2 part 2

运行时环境

- 加载 销毁程序
- 提供动态链接库
  - 运行程序所需要的公共要素被抽象成API
    - 应用程序只需要直接调用这组API即可, 无需关心自己将来运行在哪个架构上

AM

- TRM 计算
- IOE 输入输出
- CTE 上下文管理
- VME 虚存管理
- MPE 多处理器通信

> ```
> (在NEMU中)实现硬件功能 -> (在AM中)提供运行时环境 -> (在APP层)运行程序
> (在NEMU中)实现更强大的硬件功能 -> (在AM中)提供更丰富的运行时环境 -> (在APP层)运行更复杂的程序
> ```
> 把程序和架构解耦

不能直接用gcc编译，因为gcc会把程序编译成运行在linux上的可执行文件 而nemu不能提供linux的运行时环境

我们需要在GNU/Linux下根据AM的运行时环境编译出能够在`$ISA-nemu`这个新环境中运行的可执行文件



编译的大致过程

- 将对应isa的AM实现源文件编译 然后用ar打包成一个库

- 把应用程序源文件编译成目标文件

- 用gcc和ar把程序依赖的运行库klib打包成归档文件、

- 链接目标文件和归档文件

  `**归档文件**（archive file）通常指的是把多个目标文件（.o）打包在一起形成的一个静态库文件`

---

记录程序执行过程的信息称为踪迹(trace)

itrace 跟踪指令的执行

- 输出指令的pc 二进制 反汇编结果
- build/nemu-log.txt
- `grep`, `awk`, `sed`进行筛选处理 but我shell命令不会写/(ㄒoㄒ)/~~

iringbuf 指令环形缓冲区

- 在客户程序出错(例如访问物理内存越界)的时候输出最近执行的若干条指令

mtrace 程序访存的具体行为

- 在`paddr_read()`和`paddr_write()`中进行记录即可
- 开启mtrace将会产生大量的输出, 因此最好可以在不需要的时候关闭mtrace
- 参考一下itrace的相关实现吧: 尝试在Kconfig和相关文件中添加相应的代码, 使得我们可以通过menuconfig来打开或者关闭mtrace



































